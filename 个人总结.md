一致想试试国产的操作系统，终于有项目可以用来测试一下
========

## 项目内容

4G电子会议桌牌

## 硬件资源：

- 双屏的黑白红电子墨水屏
- LTE Cat.1 SIM7600模组
- SDCARD
- 32MB SPI Flash
- STM32F103RG

本项目至今花了我5天时间。
第一天，第二天，查看操作系统文档和源码
第三天，硬件准备完成，着手调试

## 目前已完成：

1. epaper 的驱动
2 . SDcard 挂载成功
3 . spi flash fal 成功识别
4 . 闪烁框架
5 . SIM7600 部分框架优化
6 . 模拟SPI总线的驱动

## 体会和经验：
  个人没有时间对RT-thread进行深层评测，仅从应用层面总结一下体会。
	
1.  系统组件比较完备，熟悉系统后比较容易定制。比如这次 SIM7600 的驱动，系统中有响应的包可以参考和利用
2.  系统的配置工具也很好，使用menuconfig 和 pkgs 就可以轻松 配置和下载 在线包
3.  对一些核心结构体，没有特别详细的说明， 对框架开发者来说，需要自己看代码 来掌握
4.  国产开发者的在线包，水平参差不齐。完成度不高

## 开发步骤：

1. 创建工程
到 bsp 目录下找到自己的 架构 比如（STM32）
在架构目录下， 找一个类型 MCU的 board 目录复制一份，改名为自己的 board名称 stm32f103-epaper-dual75
使用stm32cube mx 配置硬件功能， 生成 CubeMX_Config 目录中的文件
按需要 修改 board.c 里的时钟配置
对照 MCU的内存镜像和需要修改 linker_scripts 里的链接脚本
修改 Kconfig， 添加和删除 BSP 配置
ports 文件夹 中保存 有别于其他 board 的特殊 移植文件
	
2. 在项目文件夹下，运行 menuconfig， 配置工程和 代码包
生成新的工程文件和 rtconfig.h
下载和更新代码包
3. 编写main.c 添加测试代码
编译工程，如果有错误， 添加 include 目录

## 主要难点：

### epaper驱动

1. epaper 的 显存
    epaper 的功能限制是，必须整屏刷新，无法局部刷新，所以如果想要在任意位置显示内容，就必须先把所有内容写入显存，再整屏刷新
    epaper 的分辨率为 640x384 ，如果一个像素对应一个字节，就会非常大， 而mcu的 ram 总大小为96K，没法存放
    但是epaper为3色屏，每个点可以用2位来指定颜色。 所以缓存和 缩减为 640X384/4 个字节，60多K，可以存放在片上RAM
2. 使用 ucGUI框架， 可以轻松实现画图，汉字显示。
			由于ucGUI的最低色位是8bit，要想对应到2bit，就需要重新定义调色板，同时需要把8bit颜色位图向2bit颜色显存映射
			开启 memdev 提高速度
	
3. 前后屏的色深不一样，需要区分颜色映射。 前屏为黑白红3色，后屏为黑白2色
	
4. 要显示不同大小的汉字，需要不同的字模，目前利用现成的 hzk12 和 hzk16 。字模写在片上flash 的560K 和 824K 上，可以参考 Font_HZ13.c
	
### 模拟SPI

1. 硬件上的spi flash W25Q256 并没有使用硬件SPI，而是使用GPIO进行模拟。 要想fal 识别，必须自己实现 模拟的SPI总线框架
2. 系统没有提供模拟SPI的例子，参考SPI总线的注册和原理， 完成模拟SPI总线的框架
3. 启动时注册spi总线
	result = rt_spi_bus_register(&emu_spi_bus.spi_bus,"emu_spi", &emu_spi_ops);
4. 启动后，添加一个spi 设备，并指定CS引脚
	rt_emu_spi_device_attach("emu_spi", "spi20", GET_PIN(A, 10));
		
   启动SFUD probe
	if (RT_NULL == rt_sfud_flash_probe("W25Q256", "spi20"))
		
   成功fal 成功识别 W25Q256
	
### 闪烁框架
  看了在线包里的闪烁框架， 都很垃圾。 自己写了一个

### SIM7600
1. 不得不说 at client是个利器，调试AT 命令很有用
2. 需要写个 msh 命令 手动打开 sim7600 的电源， 然后再调试 at 才行
3. 现存代码里的几个问题
	a. 硬件status引脚不一定会使用， 所以需要 延时来确认电源开启
	b. 模组上电后，如果检测到 sim卡，会主动注册 激活，此时 AT+CGDCONT，就会没有响应，需要超时略过
	c. 模组在 AT+NETOPEN 后，不会很快的 获取到 IP 地址，所以在 AT+IPADDR 时，需要多试几次
	
### SD卡
1. 最开始不成功，是因为工程拷贝的是 stm32f103rb的board文件夹， 启动汇编文件没有修改成stm32f103rg的。
    因stm32f103rb是不支持sdio总线的，所以在启动汇编文件的中断向量表里就没有sdio的中断，使用sdio时，发生中断后，就会引起内存访问异常。
